

# Windows Desktop App Automation MCP Server 仕様書

## 1. 概要

本システムは、Windowsデスクトップアプリケーション（主に .NET WinForms 製）を、LLM（Large Language Model）から操作・検証するためのMCP（Model Context Protocol）サーバーである。

### 1.1 設計思想

- **Local Playwright for Desktop:** Webブラウザ自動化ツールのように、アプリケーションのUI構造（ボタン、入力欄、リスト等）を解析し、構造的な指定（セレクタ）に基づいて操作を行う。

- **Non-Intrusive Operation (非侵襲操作):** ユーザーの並行作業を阻害しないことを最優先とする。物理的なマウスカーソル移動やフォーカス奪取を行わず、バックグラウンドでの操作実行を原則とする。

- **Evidence Management:** 操作結果の確認や記録としてスクリーンショット機能を提供するが、これはローカル保存のみとし、プロンプトコンテキストの肥大化を防ぐ。

## 2. システム要件

### 2.1 対象アプリケーション

- **プラットフォーム:** Windows OS上で動作するGUIアプリケーション。

- **フレームワーク:** .NET Framework (Windows Forms) を主対象とするが、UI Automation (UIA) に対応したアプリケーション全般で動作可能な設計とする。

### 2.2 動作環境

- 対象アプリケーションがデスクトップ上に展開（表示）されていること。
  
  - ※最小化状態では動作しない。
  
  - ※他のウィンドウの下に隠れている状態でも、可能な限り操作可能であること。

## 3. 機能要件

### 3.1 アプリケーション接続・解析機能

- 指定されたウィンドウタイトルまたはプロセス名に基づいてアプリケーションを特定し、接続を確立する機能。

- 現在のアクティブウィンドウ内の全UI要素（コントロール）を解析し、階層構造テキストとして出力する機能。
  
  - 各要素には、操作に必要な一意の識別子（タイトル、コントロールタイプ、自動化ID等）を付与する。

### 3.2 操作実行機能 (Actions)

- **クリック/押下:** 指定されたボタンや要素に対して、マウスカーソルを移動させずに「押下イベント」を送信する。

- **テキスト設定:** 入力フィールドに対して、キーボード入力をエミュレートせず、直接値を設定する。

- **項目選択:** ドロップダウンリストやコンボボックスを展開せず、内部的な選択状態を直接変更する。

- **行選択:** データグリッドやリストビューの特定行を選択状態にする。

- **メニュー操作:** ウィンドウ上部の標準メニューバー（ファイル > 開く 等）をパス指定で実行する。

- **ウィンドウ操作:** 対象ウィンドウを閉じる、または最前面に表示する。

- **キー送信（例外的な侵襲操作）:** ショートカットキーなどを送信する。
  
  - ※本機能のみ、対象ウィンドウを一瞬アクティブ（フォーカス）にする必要がある。

### 3.3 検証・読み取り機能 (Verification)

- 指定されたUI要素の現在の表示テキスト（ラベル、入力値、メッセージ等）を取得する機能。

- 取得した値を基に、LLMが操作の成功可否を判断できるようにする。

### 3.4 視覚記録機能 (Visual Record)

- 対象ウィンドウのスクリーンショットを撮影し、指定されたファイル名でローカルに保存する機能。

- **トリミング:** デスクトップ全体ではなく、対象ウィンドウの領域のみを正確に切り抜くこと。ウィンドウの影や透明枠を含まない「見た目通り」の領域とする。

- **隠蔽対応:** 対象ウィンドウが他のウィンドウの下にある場合でも、対象ウィンドウのみを撮影できるよう、一時的な前面化などの処理を行うこと。

## 4. ツール定義 (API Specification)

LLMに公開する各ツールのインターフェース定義。

### 4.1 探索・接続

| **ツール名**      | **引数**                    | **説明**                    |
| ------------- | ------------------------- | ------------------------- |
| `connect_app` | `app_name_regex` (string) | アプリ名（正規表現）を指定して接続する。      |
| `get_ui_tree` | なし                        | 現在の画面のUI構造ツリー（テキスト）を取得する。 |

### 4.2 操作 (Actions)

| **ツール名**          | **引数**                                  | **説明**                           | **侵襲性** |
| ----------------- | --------------------------------------- | -------------------------------- | ------- |
| `click_element`   | `selector` (json)                       | 指定要素をクリックイベントで操作する。              | なし      |
| `set_text`        | `selector` (json), `text` (string)      | 指定要素にテキスト値を直接設定する。               | なし      |
| `select_item`     | `selector` (json), `item_name` (string) | リスト/コンボボックスの項目を選択する。             | なし      |
| `select_grid_row` | `selector` (json), `row_index` (int)    | グリッドの指定行を選択する。                   | なし      |
| `select_menu`     | `menu_path` (string)                    | メニューバーの項目を選択する（例: "File->Exit"）。 | なし      |
| `close_window`    | なし                                      | 接続中のウィンドウを閉じる。                   | なし      |
| `send_keys`       | `keys` (string)                         | ショートカットキーを送信する（例: "^s"）。         | **あり**  |

### 4.3 検証・記録

| **ツール名**          | **引数**              | **説明**              | **侵襲性**         |
| ----------------- | ------------------- | ------------------- | --------------- |
| `get_text`        | `selector` (json)   | 指定要素のテキスト内容を取得する。   | なし              |
| `save_screenshot` | `filename` (string) | ウィンドウのキャプチャ画像を保存する。 | **あり** (一時的前面化) |

## 5. データ構造

### 5.1 セレクタ (Selector)

UI要素を一意に特定するためのJSON構造。

JSON

```
{
  "title": "表示名称 (Nameプロパティ)",
  "control_type": "要素の種類 (Button, Edit, etc.)",
  "auto_id": "開発者定義ID (AutomationId)",
  "parent": { "title": "親要素名" }  // オプション
}
```

## 6. 制約事項

1. **入力デバイスの占有について**
   
   - 原則としてマウス・キーボードを占有しない実装とする。
   
   - ただし、`send_keys`（ショートカット送信）および `save_screenshot`（キャプチャ）実行時のみ、対象ウィンドウを一瞬アクティブにする（前面に出す）動作を許容する。

2. **画面状態について**
   
   - 対象アプリが最小化（タスクバー収納）されている場合、スクリーンショット機能および一部の操作機能はエラーを返すものとする。
   
   - ユーザーは、自動化実行中は対象アプリを最小化しない運用とする。

3. **セキュリティ**
